name: release-container-images

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

jobs:
  publish-container-image:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        apps:
          [
            ai-service,
            makeline-service,
            order-service,
            product-service,
            store-admin,
            store-front,
            virtual-customer,
            virtual-worker,
          ]

    steps:
      - name: Set environment variables
        id: set-variables
        run: |
          echo "REPOSITORY=ghcr.io/$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"
          echo "IMAGE=${{ matrix.apps }}" >> "$GITHUB_OUTPUT"
          echo "VERSION=$(echo ${GITHUB_REF#refs/tags/})" >> "$GITHUB_OUTPUT"
          echo "CREATED=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_OUTPUT"

      - name: Env variable output
        id: test-variables
        run: |
          echo ${{ steps.set-variables.outputs.REPOSITORY }}
          echo ${{ steps.set-variables.outputs.IMAGE }}
          echo ${{ steps.set-variables.outputs.VERSION }}
          echo ${{ steps.set-variables.outputs.CREATED }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: src/${{ matrix.apps }}
          file: src/${{ matrix.apps }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          build-args: |
            APP_VERSION=${{ steps.set-variables.outputs.VERSION }}
          push: true
          tags: |
            ${{ steps.set-variables.outputs.REPOSITORY }}/${{ steps.set-variables.outputs.IMAGE }}:latest
            ${{ steps.set-variables.outputs.REPOSITORY }}/${{ steps.set-variables.outputs.IMAGE }}:${{ steps.set-variables.outputs.VERSION }}
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.created=${{ steps.set-variables.outputs.CREATED }}
            org.opencontainers.image.revision=${{ steps.set-variables.outputs.VERSION }}

  update-manifests:
    runs-on: ubuntu-latest
    needs: publish-container-image
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        id: set-version
        run: |
          echo "VERSION=$(echo ${GITHUB_REF#refs/tags/})" >> "$GITHUB_OUTPUT"

      - name: Update all manifests with new version
        run: |
          VERSION=${{ steps.set-version.outputs.VERSION }}

          # =============================================================================
          # Configuration
          # =============================================================================

          # Apps that have container images in ghcr.io/azure-samples/aks-store-demo
          APPS=(
            "ai-service"
            "makeline-service"
            "order-service"
            "product-service"
            "store-admin"
            "store-front"
            "virtual-customer"
            "virtual-worker"
          )

          # =============================================================================
          # Helper function to update image tags
          # =============================================================================

          update_full_image_ref() {
            # Updates: ghcr.io/azure-samples/aks-store-demo/<app>:<old> -> ghcr.io/azure-samples/aks-store-demo/<app>:<new>
            local file=$1
            local app=$2
            local version=$3
            if [ -f "$file" ]; then
              sed -i "s|ghcr.io/azure-samples/aks-store-demo/${app}:[^\"]*|ghcr.io/azure-samples/aks-store-demo/${app}:${version}|g" "$file"
              echo "Updated full image ref for ${app} in ${file}"
            fi
          }

          update_short_image_ref() {
            # Updates: image: <app>:<old> -> image: <app>:<new> (no registry prefix)
            local file=$1
            local app=$2
            local version=$3
            if [ -f "$file" ]; then
              sed -i "s|image: ${app}:[^\"]*|image: ${app}:${version}|g" "$file"
              echo "Updated short image ref for ${app} in ${file}"
            fi
          }

          # =============================================================================
          # Update Kubernetes manifests (inline image:tag format)
          # =============================================================================

          echo "Updating root Kubernetes manifests..."
          ROOT_MANIFESTS=(
            "ai-service.yaml"
            "aks-store-all-in-one.yaml"
            "aks-store-quickstart.yaml"
            "aks-store-ingress-quickstart.yaml"
          )

          for APP in "${APPS[@]}"; do
            for FILE in "${ROOT_MANIFESTS[@]}"; do
              update_full_image_ref "$FILE" "$APP" "$VERSION"
            done
          done

          # =============================================================================
          # Update sample manifests
          # =============================================================================

          echo "Updating sample manifests..."
          SAMPLE_MANIFESTS=(
            "sample-manifests/docs/app-routing/aks-store-deployments-and-services.yaml"
            "sample-manifests/argocd/pets.yaml"
          )

          for APP in "${APPS[@]}"; do
            for FILE in "${SAMPLE_MANIFESTS[@]}"; do
              update_full_image_ref "$FILE" "$APP" "$VERSION"
            done
          done

          # =============================================================================
          # Update Kustomize base manifests
          # =============================================================================

          echo "Updating Kustomize base manifests..."
          for APP in "${APPS[@]}"; do
            update_full_image_ref "kustomize/base/${APP}.yaml" "$APP" "$VERSION"
          done

          # =============================================================================
          # Update Kustomize overlay manifests
          # =============================================================================

          echo "Updating Kustomize azd overlay manifests..."
          # azd overlay uses short image names (no registry prefix) for ACR
          for APP in "${APPS[@]}"; do
            update_short_image_ref "kustomize/overlays/azd/${APP}/deployment.yaml" "$APP" "$VERSION"
          done

          echo "Updating Kustomize kaito overlay manifests..."
          # kaito overlay uses full ghcr.io path
          update_full_image_ref "kustomize/overlays/kaito/ai-service.yaml" "ai-service" "$VERSION"

          echo "Manifest updates complete!"

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update container image tags to ${{ steps.set-version.outputs.VERSION }}"
            git push origin HEAD:main
          fi
